<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剧遇 - 编辑个人资料</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        /* 整体布局 */
        body {
            background-color: #0A192F; /* 深蓝色背景 */
            color: #FFFFFF;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 左侧侧边栏样式 */
        .sidebar {
            width: 250px;
            background-color: #112240; /* 侧边栏深蓝背景 */
            padding: 30px 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar .logo {
            font-size: 32px;
            font-weight: bold;
            color: #FFFFFF;
            margin-bottom: 40px;
            text-align: center;
            position: relative;
        }

        .sidebar .logo::after {
            content: "";
            display: block;
            width: 40px;
            height: 4px;
            background-color: #FF7F24; /* 橙色点缀 */
            margin: 10px auto 0;
            border-radius: 2px;
        }

        .sidebar .menu-list {
            list-style: none;
            margin-top: 20px;
        }

        .sidebar .menu-item {
            padding: 12px 15px;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .sidebar .menu-item.active {
            background-color: #FF7F24; /* 橙色高亮 */
            color: #FFFFFF;
        }

        .sidebar .menu-item:not(.active):hover {
            background-color: rgba(255, 127, 36, 0.2);
        }

        .sidebar .logout {
            margin-top: auto;
            padding: 12px 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            color: #CCCCCC;
            font-size: 14px;
        }

        .sidebar .logout:hover {
            color: #FF7F24;
        }

        /* 右侧主内容区 */
        .main-content {
            flex: 1;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
        }

        /* 顶部用户信息栏 */
        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .avatar-container {
            position: relative;
            cursor: pointer;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #FF7F24;
            object-fit: cover;
            background-color: #112240;
        }

        /* 隐藏的头像上传input */
        #avatar-upload {
            display: none;
        }

        .user-info {
            margin-left: 20px;
        }

        .username {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-uid {
            color: #CCCCCC;
            font-size: 14px;
        }

        .edit-btn {
            margin-left: auto;
            padding: 8px 15px;
            background-color: #112240;
            border: 1px solid #FF7F24;
            color: #FFFFFF;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        /* 表单卡片样式 */
        .profile-form-card {
            background-color: #FFFFFF;
            color: #0A192F;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            max-width: 800px;
        }

        /* 表单网格布局 */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        /* 单独占一行的表单项（个人简介、等级） */
        .form-group.full-width {
            grid-column: 1 / 3;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #0A192F;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #DDDDDD;
            border-radius: 8px;
            font-size: 16px;
            color: #0A192F;
            background-color: #F9F9F9;
        }

        .form-control:focus {
            outline: none;
            border-color: #FF7F24;
            box-shadow: 0 0 5px rgba(255, 127, 36, 0.3);
        }

        /* 等级进度条样式 */
        .level-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-text {
            font-weight: bold;
            color: #0A192F;
        }

        .progress-bar-container {
            flex: 1;
            height: 10px;
            background-color: #EEEEEE;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #FF7F24;
            border-radius: 5px;
            width: 70%; /* 示例进度，实际从接口获取 */
            transition: width 0.3s ease;
        }

        /* 文本域样式 */
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* 按钮区域 */
        .btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save {
            background-color: #112240;
            color: #FFFFFF;
        }

        .btn-save:hover {
            background-color: #172a4f;
        }

        .btn-cancel {
            background-color: #FF7F24;
            color: #FFFFFF;
        }

        .btn-cancel:hover {
            background-color: #e6701e;
        }

        /* 提示消息样式 */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: #FFFFFF;
            font-size: 16px;
            z-index: 9999;
            display: none;
        }

        .message.success {
            background-color: #28a745;
        }

        .message.error {
            background-color: #dc3545;
        }

        /* 响应式设计 - 适配移动端 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 20px;
            }

            .sidebar .menu-list {
                display: flex;
                overflow-x: auto;
                gap: 10px;
                margin-top: 10px;
            }

            .sidebar .menu-item {
                margin: 0;
                white-space: nowrap;
            }

            .main-content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-group.full-width {
                grid-column: 1;
            }

            .user-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .edit-btn {
                margin-left: 0;
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- 左侧侧边栏 -->
    <aside class="sidebar">
        <div class="logo">剧遇</div>
        <ul class="menu-list">
            <li class="menu-item active">个人信息</li>
            <li class="menu-item">首页</li>
            <li class="menu-item">好友私信</li>
        </ul>
        <div class="logout">退出登录</div>
    </aside>

    <!-- 右侧主内容区 -->
    <main class="main-content">
        <!-- 顶部用户信息 -->
        <div class="user-header">
            <div class="avatar-container">
                <img src="default-avatar.png" alt="用户头像" class="user-avatar" id="avatar-img">
                <input type="file" id="avatar-upload" accept="image/*">
            </div>
            <div class="user-info">
                <div class="username" id="username">cj06716</div>
                <div class="user-uid">User UID: <span id="user-uid">A5BBFE7C</span></div>
            </div>
            <button class="edit-btn">编辑资料</button>
        </div>

        <!-- 资料编辑表单卡片 -->
        <div class="profile-form-card">
            <form id="profile-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="nickname">昵称</label>
                        <input type="text" class="form-control" id="nickname" name="nickname" placeholder="请输入昵称">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="realname">姓名</label>
                        <input type="text" class="form-control" id="realname" name="realname" placeholder="请输入真实姓名">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="gender">性别</label>
                        <input type="text" class="form-control" id="gender" name="gender" placeholder="男/女/保密">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="hobby-type">爱好类型</label>
                        <select class="form-control" id="hobby-type" name="hobbyType">
                            <option value="">请选择爱好类型</option>
                            <option value="推理">推理</option>
                            <option value="情感">情感</option>
                            <option value="恐怖">恐怖</option>
                            <option value="欢乐">欢乐</option>
                            <option value="机制">机制</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="birthday">生日</label>
                        <input type="date" class="form-control" id="birthday" name="birthday">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="city">城市</label>
                        <input type="text" class="form-control" id="city" name="city" placeholder="请输入所在城市">
                    </div>

                    <!-- 等级显示 -->
                    <div class="form-group full-width">
                        <label class="form-label">等级</label>
                        <div class="level-container">
                            <span class="level-text" id="level">Lv.1</span>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="level-progress"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 个人简介 -->
                    <div class="form-group full-width">
                        <label class="form-label" for="intro">个人简介</label>
                        <textarea class="form-control" id="intro" name="intro" placeholder="请输入个人简介（关于剧本杀的爱好、擅长类型等）"></textarea>
                    </div>
                </div>

                <!-- 按钮区域 -->
                <div class="btn-group">
                    <button type="button" class="btn btn-cancel" id="cancel-btn">取消</button>
                    <button type="submit" class="btn btn-save" id="save-btn">保存修改</button>
                </div>
            </form>
        </div>
    </main>
</div>

<!-- 提示消息框 -->
<div class="message" id="message-box"></div>

<script>
    // 核心配置
    const API_URL = '/api/user/profile';
    let avatarFile = null; // 存储选中的头像文件

    // DOM元素获取
    const avatarImg = document.getElementById('avatar-img');
    const avatarUpload = document.getElementById('avatar-upload');
    const profileForm = document.getElementById('profile-form');
    const messageBox = document.getElementById('message-box');
    const cancelBtn = document.getElementById('cancel-btn');
    const levelProgress = document.getElementById('level-progress');

    // 页面加载时获取用户信息
    document.addEventListener('DOMContentLoaded', () => {
        fetchUserProfile();

        // 头像上传点击事件
        avatarImg.addEventListener('click', () => {
            avatarUpload.click();
        });

        // 头像文件选择事件
        avatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                avatarFile = file;
                // 预览头像
                const reader = new FileReader();
                reader.onload = (event) => {
                    avatarImg.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 表单提交事件
        profileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveUserProfile();
        });

        // 取消按钮事件
        cancelBtn.addEventListener('click', () => {
            // 跳转到个人资料界面
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username') || 'cj06716';
            window.location.href = `profile.html?username=${encodeURIComponent(username)}`;
        });
    });

    /**
     * 从后端获取用户资料
     */

    function fetchUserProfile() {
        // 从URL获取用户名
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || 'cj06716';

        fetch(`/api/user/profile?username=${encodeURIComponent(username)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取用户信息失败');
                }
                return response.json();
            })
            .then(result => {
                if (result.success && result.data) {
                    const user = result.data;
                    // 填充表单数据
                    document.getElementById('nickname').value = user.nickname || '';
                    document.getElementById('realname').value = user.realName || '';
                    document.getElementById('gender').value = user.gender === 1 ? '男' : (user.gender === 0 ? '女' : '');
                    document.getElementById('hobby-type').value = user.hobbyType || '';
                    document.getElementById('birthday').value = user.birthday ? user.birthday.toString().substring(0, 10) : '';
                    document.getElementById('city').value = user.city || '';
                    document.getElementById('intro').value = user.profile || '';
                    document.getElementById('username').textContent = user.username || 'cj06716';
                    document.getElementById('user-uid').textContent = user.uid || 'A5BBFE7C';
                    document.getElementById('level').textContent = `Lv.${user.userLevel || 1}`;

                    // 设置等级进度条
                    const progress = 70; // 示例进度，实际从接口获取
                    levelProgress.style.width = `${progress}%`;

                    // 设置头像
                    if (user.avatarUrl) {
                        avatarImg.src = user.avatarUrl;
                    } else {
                        avatarImg.src = 'default-avatar.png';
                    }
                } else {
                    throw new Error(result.msg || '获取用户信息失败');
                }
            })
            .catch(error => {
                showMessage(error.message, 'error');
                console.error('获取用户信息出错:', error);
            });
    }
    /**
     * 保存用户资料到后端
     */
    function saveUserProfile() {
        // 从URL获取用户名
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || 'cj06716';

        // 收集表单数据
        const formData = new FormData();
        formData.append('username', username);
        formData.append('nickname', document.getElementById('nickname').value);
        formData.append('realName', document.getElementById('realname').value);
        formData.append('gender', document.getElementById('gender').value === '男' ? 1 : (document.getElementById('gender').value === '女' ? 0 : null));
        formData.append('hobbyType', document.getElementById('hobby-type').value || null);
        formData.append('birthday', document.getElementById('birthday').value || null);
        formData.append('city', document.getElementById('city').value || null);
        formData.append('profile', document.getElementById('intro').value || null);

        // 如果有新头像，添加到FormData
        if (avatarFile) {
            formData.append('avatar', avatarFile);
        }

        // 发送更新请求
        fetch('/api/user/profile', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('保存资料失败，请重试');
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    showMessage('资料保存成功！', 'success');
                    fetchUserProfile(); // 重新加载最新数据
                    avatarFile = null; // 重置头像文件
                } else {
                    showMessage(result.msg || '保存资料失败，请重试', 'error');
                }
            })
            .catch(error => {
                showMessage(error.message, 'error');
                console.error('保存用户信息出错:', error);
            });
    }


    /**
     * 显示提示消息
     * @param {string} text 消息内容
     * @param {string} type 消息类型（success/error）
     */
    function showMessage(text, type) {
        messageBox.textContent = text;
        messageBox.className = `message ${type}`;
        messageBox.style.display = 'block';

        // 3秒后隐藏消息
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>