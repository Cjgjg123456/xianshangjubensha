<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰§é‡ - é˜…è¯»å‰§æœ¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", sans-serif; }
        body { width: 100vw; height: 100vh; background: url("images/bg.jpg") no-repeat center center; background-size: cover; display: flex; padding: 15px; color: #fff; overflow: hidden; }

        .container { display: flex; gap: 15px; width: 100%; height: 100%; background: rgba(10, 15, 25, 0.9); backdrop-filter: blur(20px); border-radius: 15px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); }

        /* å·¦ä¾§ï¼šè§’è‰²ä¿¡æ¯æ  */
        .role-sidebar { width: 260px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; padding: 20px; align-items: center; }
        .game-status { width: 100%; text-align: center; background: rgba(255,102,0,0.1); border: 1px solid #ff6600; color: #ff9900; padding: 8px; border-radius: 8px; font-weight: bold; margin-bottom: 25px; letter-spacing: 1px; }
        .role-avatar { width: 120px; height: 120px; border-radius: 50%; border: 3px solid #b89758; margin-bottom: 15px; object-fit: cover; box-shadow: 0 0 20px rgba(184, 151, 88, 0.3); }
        .role-name { font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .player-name { font-size: 14px; color: #aaa; margin-bottom: 20px; }

        .clue-btn { width: 100%; padding: 12px; margin-bottom: 15px; background: linear-gradient(90deg, #00b4db, #0083b0); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,180,219,0.3); }
        .clue-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,180,219,0.5); }

        .role-intro { flex: 1; width: 100%; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; font-size: 13px; color: #ccc; line-height: 1.6; overflow-y: auto; }
        .role-intro h4 { color: #b89758; margin-bottom: 8px; font-size: 15px; border-bottom: 1px solid rgba(184, 151, 88, 0.3); padding-bottom: 5px; }

        /* ä¸­é—´ï¼šå‰§æœ¬é˜…è¯»åŒº */
        .script-main { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        .script-header { padding: 15px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .script-title { font-size: 20px; font-weight: bold; color: #ddd; }
        .chapter-name { font-size: 16px; color: #ff9900; }
        .script-content-area { flex: 1; padding: 40px 60px; overflow-y: auto; }
        .script-paper { max-width: 800px; margin: 0 auto; background: rgba(20, 22, 28, 0.95); border: 1px solid #333; border-radius: 10px; padding: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .script-text { font-size: 16px; line-height: 2; color: #e0e0e0; text-align: justify; letter-spacing: 0.5px; }
        .script-text p { margin-bottom: 20px; text-indent: 2em; }
        .action-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: center; gap: 20px; background: rgba(0,0,0,0.3); border-radius: 0 0 12px 12px; }
        .btn-ready { padding: 12px 40px; font-size: 16px; font-weight: bold; border-radius: 8px; border: none; background: linear-gradient(90deg, #ff6600, #ff3300); color: #fff; cursor: pointer; transition: 0.3s; }
        .btn-ready:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,102,0,0.4); }

        /* å³ä¾§ï¼šèŠå¤©é¢‘é“ */
        .chat-sidebar { width: 320px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
        .chat-header { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; font-weight: bold; text-align: center; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg-sys { text-align: center; color: #888; font-size: 12px; margin: 5px 0;}
        .msg-item { display: flex; flex-direction: column; animation: fadeIn 0.3s forwards; }
        .msg-name { font-size: 12px; color: #aaa; margin-bottom: 3px; }
        .msg-bubble { background: rgba(255,255,255,0.08); padding: 10px 12px; border-radius: 8px; width: fit-content; max-width: 90%; font-size: 13px; line-height: 1.5; border: 1px solid rgba(255,255,255,0.05); }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        .chat-input { padding: 15px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .chat-input input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 10px; border-radius: 6px; outline: none; font-size: 13px; }
        .chat-input button { background: #ff6600; color: #fff; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }

        /* ================== çº¿ç´¢å¡å¼¹çª—æ ·å¼ ================== */
        .clue-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 200; }
        .clue-modal-content { background: rgba(20, 25, 40, 0.95); width: 850px; max-height: 80vh; border-radius: 15px; padding: 30px; border: 1px solid #00e5ff; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,229,255,0.2); }
        .clue-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; }
        .clue-title { font-size: 22px; font-weight: bold; color: #00e5ff; display: flex; align-items: center; gap: 10px; }
        .close-clue-btn { background: none; border: none; color: #aaa; font-size: 30px; cursor: pointer; transition: 0.3s; }
        .close-clue-btn:hover { color: #fff; }
        .clue-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 20px; overflow-y: auto; padding-right: 5px; }
        .clue-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; transition: 0.3s; display: flex; flex-direction: column; gap: 8px; }
        .clue-card:hover { background: rgba(0,229,255,0.05); border-color: #00e5ff; transform: translateY(-3px); }
        .clue-name { font-size: 16px; font-weight: bold; color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .clue-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; display: inline-block; white-space: nowrap; }
        .clue-tag.public { border: 1px solid #28a745; color: #28a745; background: rgba(40,167,69,0.1); }
        .clue-tag.private { border: 1px solid #dc3545; color: #dc3545; background: rgba(220,53,69,0.1); }
        .clue-loc { font-size: 12px; color: #aaa; }
        .clue-desc { font-size: 13px; color: #ddd; line-height: 1.6; margin-top: 5px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; flex: 1; }

        /* ================== å¹•æ¬¡é€‰æ‹©å™¨æ ·å¼ ================== */
        .act-selector {
            background: rgba(0, 0, 0, 0.5);
            color: #ff9900;
            border: 1px solid rgba(255, 153, 0, 0.5);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: bold;
            outline: none;
            cursor: pointer;
            transition: 0.3s;
            appearance: none;
        }
        .act-selector:hover { border-color: #ff9900; box-shadow: 0 0 10px rgba(255, 153, 0, 0.2); }
        .act-selector option { background: #1a1e29; color: #fff; }
        .act-selector option:disabled { color: #666; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <div class="role-sidebar">
        <div class="game-status">âœ¦ é˜¶æ®µï¼šé˜…è¯»å‰§æœ¬ âœ¦</div>
        <img id="roleAvatar" src="https://via.placeholder.com/120/b89758/fff?text=Role" class="role-avatar">
        <div class="role-name" id="roleName">åŠ è½½ä¸­...</div>
        <div class="player-name">ç©å®¶ï¼š<span id="playerName">---</span></div>

        <button class="clue-btn" onclick="openClueModal()">ğŸ” æŸ¥çœ‹æœ¬å¹•çº¿ç´¢å¡</button>

        <div class="role-intro">
            <h4>å…¬å¼€æƒ…æŠ¥ / äººè®¾</h4>
            <p id="roleDesc">è·å–è§’è‰²æ•°æ®ä¸­...</p>
        </div>
    </div>

    <div class="script-main">
        <div class="script-header">
            <div class="script-title" id="displayScriptName">ã€Š---ã€‹</div>
            <select class="act-selector" id="actSelector" onchange="loadSpecificAct(this.value)">
                <option value="">åŠ è½½å¹•æ¬¡ä¸­...</option>
            </select>
        </div>

        <div class="script-content-area">
            <div class="script-paper">
                <div class="script-text" id="scriptText">
                    <p style="text-align: center;">æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¸“å±å‰§æœ¬è§†è§’ï¼Œè¯·ç¨å€™...</p>
                </div>
            </div>
        </div>

        <div class="action-footer">
            <button class="btn-ready" id="readyBtn" onclick="finishReading()">æˆ‘å·²é˜…è¯»å®Œæ¯•</button>
        </div>
    </div>

    <div class="chat-sidebar">
        <div class="chat-header" id="chatTitle">å…¨æ¯å…¬å± (AIæ²‰æµ¸ä¸­)</div>
        <div class="chat-messages" id="chatBox">
            <div class="msg-sys">ç³»ç»Ÿï¼šå·²è¿›å…¥æ¸¸æˆï¼Œæœ¬é˜¶æ®µè¯·ä»”ç»†é˜…è¯»å‰§æœ¬ã€‚</div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="ä»¥è§’è‰²çš„å£å»è¯´ç‚¹ä»€ä¹ˆ...">
            <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
</div>

<div class="clue-modal-overlay" id="clueModal">
    <div class="clue-modal-content">
        <div class="clue-header">
            <div class="clue-title" id="clueModalTitle">ğŸ” æœ¬å¹•å·²è§£é”çº¿ç´¢</div>
            <button class="close-clue-btn" onclick="closeClueModal()">Ã—</button>
        </div>
        <div class="clue-grid" id="clueGrid">
        </div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/api/game';
    const urlParams = new URLSearchParams(window.location.search);
    let currentGameId = urlParams.get('gameId');
    let myRoleName = 'æˆ‘';
    let chatHistory = [];

    // ã€ä¿®æ”¹ç‚¹1ã€‘ï¼šå…¨å±€å˜é‡è®°å½•ç©å®¶å½“å‰æ­£åœ¨ä¸‹æ‹‰æ¡†ä¸­è§‚çœ‹çš„å¹•æ¬¡ID
    let currentViewActId = null;

    // ================= åˆå§‹åŒ–é¡µé¢ä¸å‰§æœ¬å†…å®¹ =================
    window.onload = async function() {
        document.getElementById('playerName').innerText = localStorage.getItem('loginUsername') || 'ç©å®¶';
        if (!currentGameId) {
            alert("ç¼ºå°‘æ¸¸æˆè¿›åº¦ï¼è¯·ä»å¤§å…é‡æ–°å¼€æˆ¿ã€‚");
            return;
        }

        try {
            const actRes = await fetch(`${API_BASE}/content?gameId=${currentGameId}`).then(r => r.json());

            if (actRes.success && actRes.data) {
                const contentData = actRes.data;
                // ã€ä¿®æ”¹ç‚¹2ã€‘ï¼šé¦–æ¬¡åŠ è½½æ—¶ï¼Œé»˜è®¤è§‚çœ‹çš„æ˜¯å½“å‰æœ€æ–°çš„å¹•æ¬¡
                currentViewActId = contentData.actId;

                // å®Œç¾æ¸²æŸ“å¤šå¹•èƒŒæ™¯å’Œæœºå¯†
                document.getElementById('scriptText').innerHTML = `
                    <div style="margin-bottom:30px; padding:20px; background:rgba(255,153,0,0.1); border-radius:8px; border:1px solid rgba(255,153,0,0.3);">
                        <h4 style="color:#ff9900; margin-bottom:10px;">ğŸ“œ å…¬å…±æ•…äº‹èƒŒæ™¯</h4>
                        <div style="font-size:15px; line-height:1.8;">${contentData.publicContent}</div>
                    </div>
                    <div>
                        <h4 style="color:#00e5ff; margin-bottom:10px;">ğŸ¤« æ‚¨çš„ä¸“å±æœºå¯†å‰§æƒ…</h4>
                        <div style="font-size:15px; line-height:1.8;">${contentData.privateContent}</div>
                    </div>
                `;

                // è·å–å‰§æœ¬è¯¦æƒ…ä»¥æ¸²æŸ“å¹•æ¬¡ä¸‹æ‹‰æ¡†
                const detailRes = await fetch(`${API_BASE}/detail?scriptId=${contentData.scriptId}`).then(r => r.json());
                if (detailRes.success && detailRes.data && detailRes.data.acts) {
                    const allActs = detailRes.data.acts;
                    allActs.sort((a, b) => a.sort - b.sort); // ç¡®ä¿å¹•æ¬¡æŒ‰å…ˆåé¡ºåºæ’åˆ—

                    // æ‰¾å‡ºå½“å‰è¿›è¡Œåˆ°çš„å¹•æ¬¡åºå· (ç”¨äºåˆ¤æ–­å“ªäº›å¹•æ¬¡å·²è§£é”)
                    const currentAct = allActs.find(a => a.actName === contentData.actName);
                    const currentSort = currentAct ? currentAct.sort : 999;

                    const selector = document.getElementById('actSelector');
                    selector.innerHTML = ''; // æ¸…ç©ºé»˜è®¤é¡¹

                    allActs.forEach(act => {
                        let option = document.createElement('option');
                        option.value = act.actId;

                        if (act.sort <= currentSort) {
                            // å·²è§£é”çš„å¹•æ¬¡
                            option.text = act.actName;
                            if (act.actName === contentData.actName) {
                                option.selected = true; // é»˜è®¤é€‰ä¸­å½“å‰æ­£åœ¨è¿›è¡Œçš„å¹•æ¬¡
                            }
                        } else {
                            // æœªè§£é”çš„å¹•æ¬¡
                            option.text = `ğŸ”’ ${act.actName} (æœªè§£é”)`;
                            option.disabled = true;
                        }
                        selector.appendChild(option);
                    });
                }

                const scriptsRes = await fetch(`${API_BASE}/scripts`).then(r => r.json());
                const script = scriptsRes.data.find(s => s.scriptId === contentData.scriptId);
                if (script) document.getElementById('displayScriptName').innerText = `ã€Š${script.title}ã€‹`;

                const rolesRes = await fetch(`${API_BASE}/roles?scriptId=${contentData.scriptId}`).then(r => r.json());
                const myRole = rolesRes.data.find(r => r.roleId === contentData.roleId);
                if (myRole) {
                    myRoleName = myRole.name;
                    document.getElementById('roleName').innerText = myRole.name;
                    document.getElementById('roleDesc').innerText = myRole.background;
                    if(myRole.avatar) document.getElementById('roleAvatar').src = myRole.avatar;
                }
            } else {
                document.getElementById('scriptText').innerHTML = `<p style="color:red; text-align:center;">å‰§æœ¬åŠ è½½å¤±è´¥ï¼š${actRes.msg}</p>`;
            }
        } catch (e) {
            document.getElementById('scriptText').innerHTML = `<p style="color:red; text-align:center;">ç½‘ç»œå¼‚å¸¸ï¼Œæ— æ³•è¿æ¥æœåŠ¡å™¨</p>`;
        }
    };

    // ================= çº¿ç´¢å¡ç›¸å…³åŠŸèƒ½ =================
    async function openClueModal() {
        document.getElementById('clueModal').style.display = 'flex';
        const grid = document.getElementById('clueGrid');

        // ã€ä¿®æ”¹ç‚¹3ã€‘ï¼šåŠ¨æ€ä¿®æ”¹çº¿ç´¢å¼¹çª—çš„æ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰æ‰€åœ¨çš„å¹•æ¬¡åç§°
        const actSelect = document.getElementById('actSelector');
        let actNameStr = "æœªçŸ¥å¹•æ¬¡";
        if(actSelect.selectedIndex >= 0) {
            actNameStr = actSelect.options[actSelect.selectedIndex].text;
        }
        document.getElementById('clueModalTitle').innerText = `ğŸ” ${actNameStr} - ä¸“å±çº¿ç´¢`;

        grid.innerHTML = '<div style="color:#aaa; grid-column:1/-1; text-align:center; padding-top: 20px;">æ­£åœ¨åŠ è½½çº¿ç´¢æ‰«æä»ª...</div>';

        try {
            const res = await fetch(`${API_BASE}/clues?gameId=${currentGameId}`).then(r => r.json());
            if (res.success && res.data) {

                // ã€ä¿®æ”¹ç‚¹4ã€‘ï¼šæ ¸å¿ƒé€»è¾‘ï¼å¯¹è·å–åˆ°çš„æ‰€æœ‰çº¿ç´¢è¿›è¡Œè¿‡æ»¤ï¼Œåªä¿ç•™ unlockChapterId åŒ¹é…å½“å‰è§‚çœ‹å¹•æ¬¡ currentViewActId çš„çº¿ç´¢
                const actSpecificClues = res.data.filter(clue => clue.unlockChapterId == currentViewActId);

                if (actSpecificClues.length === 0) {
                    grid.innerHTML = '<div style="color:#aaa; grid-column:1/-1; text-align:center; padding-top: 20px;">æœ¬å¹•æš‚æ— å‘ç°ä»»ä½•çº¿ç´¢ï¼Œè¯·ç»§ç»­é˜…è¯»æˆ–æ¨è¿›å‰§æƒ…ã€‚</div>';
                    return;
                }

                let html = '';
                // éå†è¿‡æ»¤åçš„ç‰¹å®šå¹•æ¬¡çº¿ç´¢
                actSpecificClues.forEach(clue => {
                    let isPublic = clue.isPublic === 1;
                    let tagClass = isPublic ? 'public' : 'private';
                    let tagName = isPublic ? 'å…¬å…±' : 'ä¸“å±æœºå¯†';

                    html += `
                    <div class="clue-card">
                        <div class="clue-name">
                            <span>${clue.clueName}</span>
                            <span class="clue-tag ${tagClass}">${tagName}</span>
                        </div>
                        <div class="clue-loc">ğŸ“ æœæŸ¥åœ°ç‚¹ï¼š${clue.locationName || 'æœªçŸ¥ç°åœº'}</div>
                        <div class="clue-desc">${clue.clueDesc || 'æš‚æ— è¯¦ç»†æè¿°'}</div>
                    </div>`;
                });
                grid.innerHTML = html;
            } else {
                grid.innerHTML = `<div style="color:red; grid-column:1/-1; text-align:center;">è·å–çº¿ç´¢å¤±è´¥: ${res.msg}</div>`;
            }
        } catch(e) {
            grid.innerHTML = `<div style="color:red; grid-column:1/-1; text-align:center;">ç½‘ç»œè¿æ¥å¼‚å¸¸</div>`;
        }
    }

    function closeClueModal() {
        document.getElementById('clueModal').style.display = 'none';
    }

    // ================= å¯¹è¯ä¸çŠ¶æ€æµè½¬ =================
    async function finishReading() {
        const btn = document.getElementById('readyBtn');
        btn.innerText = "DeepSeek æ€è€ƒä¸­ (è¯·ç¨å€™ 5~10 ç§’)...";
        btn.style.background = "#555";
        btn.disabled = true;

        receiveSysMessage("ç³»ç»Ÿ", "ã€æˆ‘ã€‘å·²é˜…è¯»å®Œæ¯•ï¼Œç­‰å¾…å…¶ä»– AI è§’è‰²å¼€åœºå‘è¨€...");

        try {
            const res = await fetch(`${API_BASE}/finishReading?gameId=${currentGameId}`, { method: 'POST' }).then(r => r.json());

            if (res.success && res.data && res.data.length > 0) {
                res.data.forEach(ai => {
                    receiveAiMessage(ai.roleName, ai.reply);
                    chatHistory.push({ role: "assistant", content: `${ai.roleName}è¯´ï¼š${ai.reply}` });
                });
            } else {
                receiveSysMessage("ç³»ç»Ÿæç¤º", "æˆ¿é—´å†…æ²¡æœ‰å…¶ä»– AI è§’è‰²ï¼Œæˆ–è·å–å¤±è´¥ã€‚");
            }
        } catch(e) {
            receiveSysMessage("ç³»ç»Ÿé”™è¯¯", "æ— æ³•è¿æ¥ AI æœåŠ¡æ¥å£ã€‚");
        } finally {
            btn.innerText = "è¿›å…¥ä¸‹ä¸€å¹• / ç»“ç®—";
            btn.style.background = "linear-gradient(90deg, #00e5ff, #0072ff)";
            btn.disabled = false;
            btn.onclick = nextAct;
        }
    }

    async function nextAct() {
        const res = await fetch(`${API_BASE}/nextAct?gameId=${currentGameId}`, { method: 'POST' }).then(r => r.json());
        if (res.success) {
            if (res.data.status === 'end') {
                alert("å…¨å‰§ç»ˆï¼å‰§æœ¬å·²ç»èµ°å®Œã€‚å³å°†è¿”å›å¤§å…ï¼");
                window.location.href = 'room.html';
            } else {
                window.location.reload();
            }
        }
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const text = input.value.trim();

        if(text) {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML += `
                <div class="msg-item" style="align-items: flex-end; margin-top: 10px;">
                    <div class="msg-name">${myRoleName} (æˆ‘)</div>
                    <div class="msg-bubble" style="background: linear-gradient(135deg, #ff6600, #ff3300); color: #fff;">${text}</div>
                </div>
            `;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            chatHistory.push({ role: "user", content: `ç©å®¶æ‰®æ¼”çš„ã€${myRoleName}ã€‘è¯´ï¼š${text}` });

            sendBtn.innerText = "AIæ€è€ƒä¸­...";
            sendBtn.disabled = true;
            input.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        gameId: parseInt(currentGameId),
                        history: chatHistory
                    })
                }).then(r => r.json());

                if (res.success && res.data) {
                    receiveAiMessage(res.data.aiName, res.data.reply);
                    chatHistory.push({ role: "assistant", content: `${res.data.aiName}è¯´ï¼š${res.data.reply}` });
                } else {
                    receiveSysMessage("ç³»ç»Ÿè­¦å‘Š", "åç«¯å¤§æ¨¡å‹å¼‚å¸¸ï¼š" + res.msg);
                }
            } catch (e) {
                receiveSysMessage("ç³»ç»Ÿé”™è¯¯", "è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡ã€‚");
            } finally {
                sendBtn.innerText = "å‘é€";
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }
    }

    function receiveSysMessage(name, text) {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="msg-sys" style="color:#ff3333; font-weight:bold;">${name}ï¼š${text}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function receiveAiMessage(name, text) {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `
            <div class="msg-item" style="margin-top: 10px;">
                <div class="msg-name" style="color:#00e5ff; font-weight:bold;">ğŸ¤– ${name}</div>
                <div class="msg-bubble" style="background: rgba(0, 229, 255, 0.1); border: 1px solid rgba(0, 229, 255, 0.3);">
                    ${text}
                </div>
            </div>
        `;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if(e.key === 'Enter') sendMessage();
    });

    // ================= åˆ‡æ¢å¹•æ¬¡å†…å®¹ =================
    async function loadSpecificAct(actId) {
        if (!actId) return;

        // ã€ä¿®æ”¹ç‚¹5ã€‘ï¼šå½“ä¸‹æ‹‰æ¡†å‘ç”Ÿæ”¹å˜æ—¶ï¼ŒåŒæ­¥æ›´æ–° currentViewActId å˜é‡
        currentViewActId = parseInt(actId);

        // å¢åŠ è¿‡æ¸¡åŠ¨ç”»æç¤º
        document.getElementById('scriptText').innerHTML = `<p style="text-align: center; color: #ff9900;">â³ æ­£åœ¨ç¿»é˜…æ—§æ¡£æ¡ˆï¼Œå›æº¯è®°å¿†ä¸­...</p>`;

        try {
            // è°ƒç”¨åç«¯ /content æ¥å£ï¼Œä¼ å…¥ç‰¹å®šçš„ actId è·å–å†å²å‰§æœ¬
            const actRes = await fetch(`${API_BASE}/content?gameId=${currentGameId}&actId=${actId}`).then(r => r.json());

            if (actRes.success && actRes.data) {
                const contentData = actRes.data;
                document.getElementById('scriptText').innerHTML = `
                    <div style="margin-bottom:30px; padding:20px; background:rgba(255,153,0,0.1); border-radius:8px; border:1px solid rgba(255,153,0,0.3);">
                        <h4 style="color:#ff9900; margin-bottom:10px;">ğŸ“œ å…¬å…±æ•…äº‹èƒŒæ™¯</h4>
                        <div style="font-size:15px; line-height:1.8;">${contentData.publicContent}</div>
                    </div>
                    <div>
                        <h4 style="color:#00e5ff; margin-bottom:10px;">ğŸ¤« æ‚¨çš„ä¸“å±æœºå¯†å‰§æƒ…</h4>
                        <div style="font-size:15px; line-height:1.8;">${contentData.privateContent}</div>
                    </div>
                `;
            } else {
                document.getElementById('scriptText').innerHTML = `<p style="color:red; text-align:center;">å‰§æœ¬åŠ è½½å¤±è´¥ï¼š${actRes.msg}</p>`;
            }
        } catch (e) {
            document.getElementById('scriptText').innerHTML = `<p style="color:red; text-align:center;">ç½‘ç»œå¼‚å¸¸ï¼Œæ— æ³•è¿æ¥æœåŠ¡å™¨</p>`;
        }
    }
</script>
</body>
</html>