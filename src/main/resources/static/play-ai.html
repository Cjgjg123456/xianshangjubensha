<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå‰§æœ¬æ€ - æ²‰æµ¸å¼æ¸¸ç©</title>
    <style>
        * { box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { background-color: #1a1a1a; color: #e0e0e0; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background: #2a2a2a; border-radius: 10px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1, h2, h3 { color: #d4b475; text-align: center; }
        .btn { background: #b89758; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.3s; margin: 10px 0; }
        .btn:hover { background: #d4b475; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        .view { display: none; } /* é»˜è®¤éšè—æ‰€æœ‰è§†å›¾ */
        .view.active { display: block; } /* æ˜¾ç¤ºå½“å‰è§†å›¾ */

        /* åˆ—è¡¨æ ·å¼ */
        .card-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .card { background: #333; padding: 20px; border-radius: 8px; border-left: 5px solid #b89758; display: flex; justify-content: space-between; align-items: center; }
        .card-info h3 { margin: 0 0 10px 0; text-align: left; }
        .card-info p { margin: 0; color: #aaa; font-size: 14px; }

        /* å‰§æœ¬é˜…è¯»åŒº */
        .script-content { background: #222; padding: 20px; border-radius: 8px; line-height: 1.8; font-size: 16px; white-space: pre-wrap; margin-bottom: 20px; border: 1px solid #444; min-height: 200px; }

        /* AIå‘è¨€åŒº */
        .chat-box { display: flex; margin-bottom: 15px; background: #333; padding: 15px; border-radius: 8px; }
        .chat-avatar { width: 50px; height: 50px; background: #555; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; color: #d4b475; }
        .chat-text { flex: 1; }
        .chat-name { font-weight: bold; color: #d4b475; margin-bottom: 5px; }

        .loading { text-align: center; color: #b89758; font-style: italic; margin: 20px 0; }

        /* æ ‡ç­¾åˆ‡æ¢æ ·å¼ (ç”¨äºå‰§æœ¬ä¸çº¿ç´¢çš„åˆ‡æ¢) */
        .act-tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .act-tab-btn { background: #444; color: #ccc; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 16px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .act-tab-btn:hover { background: #666; }
        .act-tab-btn.active-tab { background: #d4b475; color: #1a1a1a; font-weight: bold; transform: scale(1.05); }

        /* ç¿»é¡µæ§ä»¶æ ·å¼ */
        .pagination-controls { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; gap: 20px; background: #333; padding: 10px; border-radius: 8px; }
        .pagination-controls span { font-size: 15px; color: #d4b475; font-weight: bold; }

        /* å‰§æœ¬è¿›åº¦ä¸‹æ‹‰æ¡†æ ·å¼ */
        .act-selector-container { text-align: center; margin-bottom: 25px; background: #222; padding: 15px; border-radius: 8px; border: 1px dashed #555; }
        .act-selector { padding: 10px 15px; font-size: 16px; background: #111; color: #d4b475; border: 1px solid #b89758; border-radius: 5px; outline: none; cursor: pointer; min-width: 250px; font-weight: bold; }
        .act-selector:focus { border-color: #00e5ff; }
        .act-selector option:disabled { color: #666; font-style: italic; background: #222; }
    </style>
</head>
<body>

<div class="container">

    <div id="view-scripts" class="view active">
        <h1>å‰§æœ¬å¤§å…</h1>
        <p style="text-align: center;">é€‰æ‹©ä¸€ä¸ªå‰§æœ¬å¼€å§‹ä½ çš„æ¨ç†ä¹‹æ—…</p>
        <div id="script-list" class="card-list"></div>
    </div>

    <div id="view-roles" class="view">
        <h1>é€‰æ‹©è§’è‰²</h1>
        <button class="btn" onclick="switchView('view-scripts')">â† è¿”å›å¤§å…</button>
        <div id="role-list" class="card-list"></div>
    </div>

    <div id="view-play" class="view">

        <div class="act-selector-container">
            <label for="act-select" style="color: #aaa; font-size: 15px; margin-right: 10px;">ğŸ“œ å‰§æœ¬è¿›åº¦ï¼š</label>
            <select id="act-select" class="act-selector" onchange="changeAct(this.value)">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <div class="act-tabs">
            <button id="btn-tab-script" class="act-tab-btn active-tab" onclick="switchPlayTab('script')">ğŸ“– é˜…è¯»å‰§æœ¬</button>
            <button id="btn-tab-clue" class="act-tab-btn" onclick="switchPlayTab('clue')">ğŸ” æœ¬å¹•çº¿ç´¢</button>
        </div>

        <div id="play-script-container">
            <h1 id="act-title">å½“å‰å¹•</h1>
            <div id="act-content" class="script-content">åŠ è½½ä¸­...</div>
            <div id="pagination-controls" class="pagination-controls"></div>
        </div>

        <div id="play-clue-container" style="display: none;">
            <h1 id="clue-title">æœ¬å¹•çº¿ç´¢</h1>
            <div id="clue-list" class="card-list" style="margin-bottom: 20px;"></div>
        </div>

        <button id="btn-finish-read" class="btn" style="width: 100%; display: none;" onclick="finishReading()">æˆ‘å·²é˜…è¯»å®Œæ¯•ï¼Œå¼€å§‹è®¨è®º</button>
        <button id="btn-view-discuss" class="btn" style="width: 100%; display: none; background: #00e5ff; color: #111;" onclick="switchView('view-discuss')">è¿›å…¥ / è¿”å›è®¨è®ºé˜¶æ®µ</button>
    </div>

    <div id="view-discuss" class="view">
        <h1>äººæœºè®¨è®ºé˜¶æ®µ</h1>
        <div id="ai-loading" class="loading" style="display: none;">ğŸ¤– AI æ­£åœ¨ç–¯ç‹‚æ€è€ƒå’Œç»„ç»‡è¯­è¨€ä¸­ï¼Œè¯·ç¨å€™...</div>
        <div id="chat-container"></div>
        <button class="btn" style="width: 100%; margin-top: 10px; background: #444;" onclick="switchView('view-play')">â† è¿”å›ç»§ç»­çœ‹å‰§æœ¬/çº¿ç´¢</button>
        <button id="btn-next-act" class="btn" style="width: 100%; display: none; margin-top: 15px;" onclick="nextAct()">è¿›å…¥ä¸‹ä¸€å¹•</button>
    </div>

    <div id="view-end" class="view">
        <h1>æ¸¸æˆç»“æŸ</h1>
        <p style="text-align: center;">çœŸç›¸åªæœ‰ä¸€ä¸ªï¼ä½ ç›˜å‡ºçœŸæ­£çš„å‡¶æ‰‹äº†å—ï¼Ÿ</p>
        <button class="btn" style="width: 100%;" onclick="location.reload()">è¿”å›é¦–é¡µ</button>
    </div>

</div>

<script>
    const API_BASE = 'http://localhost:8080/api/game';
    let currentScriptId = null;
    let currentGameId = null;
    let currentUserId = 1; // æ¨¡æ‹Ÿå½“å‰ç™»å½•ç”¨æˆ·ID

    // --- å…¨å±€æ ¸å¿ƒçŠ¶æ€æœº ---
    let allActs = [];               // å­˜æ”¾è¯¥å‰§æœ¬çš„æ‰€æœ‰å¹•æ¬¡åŸºæœ¬ä¿¡æ¯ (ç”¨äºä¸‹æ‹‰æ¡†å±•ç¤ºé”)
    let unlockedActIds = [];        // å­˜æ”¾å·²ç»è§£é”è¿‡çš„å¹•æ¬¡IDåˆ—è¡¨
    let discussedActIds = [];       // å­˜æ”¾å·²ç»è¿›è¡Œè¿‡AIè®¨è®ºçš„å¹•æ¬¡ID
    let currentGameActId = null;    // æ¸¸æˆå®é™…è¿›è¡Œåˆ°çš„æœ€è¿œ(æœ€æ–°)å¹•æ¬¡ID
    let currentViewingActId = null; // ç©å®¶å½“å‰æ­£åœ¨ä¸‹æ‹‰æ¡†ä¸­ã€æŸ¥çœ‹ã€‘çš„å¹•æ¬¡ID
    let allClues = [];              // è·å–åˆ°çš„æ‰€æœ‰çº¿ç´¢

    // ç¿»é¡µç›¸å…³å˜é‡
    let currentTextPages = [];
    let currentViewingPageIndex = 0;
    const PAGE_SIZE = 600;

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    // 1. åŠ è½½å‰§æœ¬åˆ—è¡¨
    async function loadScripts() {
        try {
            const res = await fetch(`${API_BASE}/scripts`).then(r => r.json());
            if (res.success) {
                const list = document.getElementById('script-list');
                list.innerHTML = res.data.map(s => `
                    <div class="card">
                        <div class="card-info">
                            <h3>${s.title} <span style="font-size:12px;color:#b89758;">(${s.difficulty} | ${s.playerCount}äºº)</span></h3>
                            <p>${s.intro}</p>
                        </div>
                        <button class="btn" onclick="loadRoles(${s.scriptId})">æŸ¥çœ‹è§’è‰²</button>
                    </div>
                `).join('');
            }
        } catch (e) { console.error("åŠ è½½å‰§æœ¬åˆ—è¡¨å¤±è´¥:", e); }
    }

    // 2. åŠ è½½è§’è‰²åˆ—è¡¨
    async function loadRoles(scriptId) {
        currentScriptId = scriptId;
        try {
            const res = await fetch(`${API_BASE}/roles?scriptId=${scriptId}`).then(r => r.json());
            if (res.success) {
                const list = document.getElementById('role-list');
                list.innerHTML = res.data.map(r => `
                    <div class="card">
                        <div class="card-info">
                            <h3>${r.name} ${r.isAi === 1 ? 'ğŸ¤–(AI)' : 'ğŸ‘¤(ç©å®¶)'}</h3>
                            <p>${r.background}</p>
                        </div>
                        ${r.isAi === 0 ? `<button class="btn" onclick="startGame(${r.roleId})">é€‰æ‹©å¹¶å¼€å§‹</button>` : `<button class="btn" disabled>ä¸å¯é€‰</button>`}
                    </div>
                `).join('');
                switchView('view-roles');
            }
        } catch (e) { console.error("åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:", e); }
    }

    // 3. å¼€å§‹æ¸¸æˆ
    async function startGame(roleId) {
        // é‡ç½®æ‰€æœ‰çŠ¶æ€æœº
        unlockedActIds = [];
        discussedActIds = [];
        allActs = [];
        allClues = [];

        try {
            // æ ¸å¿ƒæ­¥éª¤ï¼šæå‰è·å–å‰§æœ¬çš„ã€æ‰€æœ‰ã€‘å¹•æ¬¡ç»“æ„ä¿¡æ¯ï¼Œä¾›ä¸‹æ‹‰æ¡†æ¸²æŸ“ä½¿ç”¨
            const detailRes = await fetch(`${API_BASE}/detail?scriptId=${currentScriptId}`).then(r => r.json());
            if (detailRes.success && detailRes.data) {
                allActs = detailRes.data.acts || [];
                allActs.sort((a, b) => a.sort - b.sort); // ç¡®ä¿æŒ‰é¡ºåºæ’åˆ—
            }

            const res = await fetch(`${API_BASE}/start?userId=${currentUserId}&scriptId=${currentScriptId}&roleId=${roleId}`, { method: 'POST' }).then(r => r.json());
            if (res.success) {
                currentGameId = res.data.gameId;
                currentGameActId = res.data.currentActId;
                unlockedActIds.push(currentGameActId);

                // åŠ è½½å¹¶æ˜¾ç¤ºæ¸¸æˆçš„æœ€æ–°çš„è¿™å¹•æ•°æ®
                loadActData(currentGameActId);
            } else {
                alert(res.msg);
            }
        } catch (e) { console.error("å¼€å§‹æ¸¸æˆå¤±è´¥:", e); alert("ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚"); }
    }

    // --- æ ¸å¿ƒæ–¹æ³•ï¼šåŠ è½½å¹¶æ¸²æŸ“æŒ‡å®šIDçš„å¹•æ¬¡å†…å®¹ï¼ˆå‰§æœ¬+çº¿ç´¢ï¼‰ ---
    async function loadActData(actId) {
        currentViewingActId = parseInt(actId);
        switchView('view-play');
        switchPlayTab('script'); // é»˜è®¤åˆ‡åˆ°çœ‹å‰§æœ¬çŠ¶æ€

        document.getElementById('act-content').innerHTML = 'æ­£åœ¨æ‹‰å–è®°å¿†...';
        document.getElementById('pagination-controls').innerHTML = '';
        document.getElementById('btn-finish-read').style.display = 'none';
        document.getElementById('btn-view-discuss').style.display = 'none';

        try {
            // 1. è·å–æŒ‡å®šå¹•çš„å‰§æœ¬å†…å®¹ï¼ˆé€šè¿‡ä¼ å…¥ actId è·å–å†å²å‰§æœ¬å†…å®¹ï¼‰
            const res = await fetch(`${API_BASE}/content?gameId=${currentGameId}&actId=${currentViewingActId}`).then(r => r.json());

            // 2. è·å–ç›®å‰å·²è§£é”çš„æ‰€æœ‰çº¿ç´¢
            const clueRes = await fetch(`${API_BASE}/clues?gameId=${currentGameId}`).then(r => r.json());
            if (clueRes.success) allClues = clueRes.data || [];

            // 3. æ¸²æŸ“é¡¶éƒ¨çš„â€œæ‰€æœ‰å¹•â€ä¸‹æ‹‰é€‰æ‹©æ¡†
            renderActDropdown();

            // 4. å¤„ç†å¹¶åˆ†é¡µå‰§æœ¬å†…å®¹
            if (res.success && res.data) {
                let currentData = res.data;
                let pubText = currentData.publicContent ? `<p style="color:#b89758;font-weight:bold;">ã€å…¬å…±å‰§æƒ…ã€‘</p><p>${currentData.publicContent.replace(/\n/g, '<br>')}</p>` : '';
                let privText = currentData.privateContent ? `<p style="color:#b89758;font-weight:bold;">ã€ä¸“å±å‰§æƒ…ã€‘</p><p>${currentData.privateContent.replace(/\n/g, '<br>')}</p>` : '';
                let combinedContent = pubText + privText;

                if (!combinedContent) combinedContent = "<p>ï¼ˆè¯¥å¹•æš‚æ— å‰§æœ¬æ–‡å­—å†…å®¹ï¼‰</p>";

                let displayTitle = currentData.actName || `ç¬¬ ${currentViewingActId} å¹•`;
                document.getElementById('act-title').innerText = displayTitle;
                document.getElementById('clue-title').innerText = `${displayTitle} - æœæŸ¥åˆ°çš„çº¿ç´¢`;

                currentTextPages = paginateText(combinedContent, PAGE_SIZE);
                renderPage(0);
            } else {
                document.getElementById('act-content').innerHTML = 'æ‹‰å–å‰§æœ¬å¤±è´¥ï¼š' + (res.msg || 'æœªçŸ¥é”™è¯¯');
            }

            // 5. æ¸²æŸ“å¯¹åº”çš„çº¿ç´¢å¡ç‰‡
            renderClues();

        } catch (e) { console.error("æ‹‰å–æ•°æ®å¤±è´¥:", e); }
    }

    // æ¸²æŸ“ä¸‹æ‹‰æ¡†ï¼šæ˜¾ç¤ºæ‰€æœ‰å¹•ï¼Œæœªè§£é”çš„è®¾ä¸º disabled
    function renderActDropdown() {
        const select = document.getElementById('act-select');
        select.innerHTML = '';
        allActs.forEach((act, index) => {
            const opt = document.createElement('option');
            opt.value = act.actId;
            let actName = act.actName || `ç¬¬ ${index + 1} å¹•`;

            if (!unlockedActIds.includes(act.actId)) {
                opt.disabled = true;
                opt.innerText = actName + ' (ğŸ”’ æœªè§£é”)';
            } else {
                opt.innerText = actName + ' (ğŸ”“ å¯ç¿»é˜…)';
            }

            if (act.actId === currentViewingActId) {
                opt.selected = true;
            }
            select.appendChild(opt);
        });
    }

    // ä¸‹æ‹‰æ¡†æ”¹å˜æ—¶è§¦å‘
    function changeAct(actId) {
        if(actId) loadActData(actId);
    }

    // åˆ‡æ¢å‰§æœ¬/çº¿ç´¢ Tab é¡µé¢
    function switchPlayTab(tab) {
        if (tab === 'script') {
            document.getElementById('play-script-container').style.display = 'block';
            document.getElementById('play-clue-container').style.display = 'none';
            document.getElementById('btn-tab-script').classList.add('active-tab');
            document.getElementById('btn-tab-clue').classList.remove('active-tab');
        } else {
            document.getElementById('play-script-container').style.display = 'none';
            document.getElementById('play-clue-container').style.display = 'block';
            document.getElementById('btn-tab-script').classList.remove('active-tab');
            document.getElementById('btn-tab-clue').classList.add('active-tab');
        }
    }

    // æ¸²æŸ“æœ¬å¹•ç»‘å®šçš„ä¸“å±çº¿ç´¢
    function renderClues() {
        const clueList = document.getElementById('clue-list');
        // æ ¸å¿ƒé€»è¾‘ï¼šä»æ‰€æœ‰è§£é”çš„çº¿ç´¢ä¸­ï¼Œè¿‡æ»¤å‡ºå±äºâ€œå½“å‰æ­£åœ¨æŸ¥çœ‹çš„è¿™ä¸€å¹•â€çš„çº¿ç´¢
        let actClues = allClues.filter(c => c.unlockChapterId == currentViewingActId);

        if (actClues.length === 0) {
            clueList.innerHTML = '<p style="text-align:center; color:#888; font-style:italic;">æœ¬å¹•ä½ æš‚æœªè·å¾—ä»»ä½•çº¿ç´¢...</p>';
            return;
        }

        clueList.innerHTML = actClues.map(c => `
            <div class="card" style="border-left: 5px solid #00e5ff;">
                <div class="card-info">
                    <h3 style="color:#00e5ff; margin-bottom: 5px;">ğŸ” ${c.clueName}
                        ${c.isPublic == 1 ? '<span style="font-size:12px;color:#aaa;font-weight:normal;">(å…¬å¼€çº¿ç´¢)</span>' : '<span style="font-size:12px;color:#d4b475;font-weight:normal;">(ä½ çš„ç§å¯†çº¿ç´¢)</span>'}
                    </h3>
                    <p style="color:#eee; font-size:15px; margin-top:5px;">${c.clueDesc || 'æš‚æ— æè¿°'}</p>
                </div>
            </div>
        `).join('');
    }

    // æ™ºèƒ½æ–‡æœ¬åˆ†é¡µåŠŸèƒ½ (å…¼å®¹ HTML)
    function paginateText(text, pageSize) {
        if (!text) return ["<p>æ— å†…å®¹</p>"];
        let pages = [];
        if (text.includes('</p>')) {
            let parts = text.split('</p>');
            parts = parts.filter(p => p.trim() !== '');
            let currentPage = "";
            for (let i = 0; i < parts.length; i++) {
                let part = parts[i] + '</p>';
                let pureTextLength = part.replace(/<[^>]+>/g, '').length;
                let currentPureLength = currentPage.replace(/<[^>]+>/g, '').length;
                if (currentPureLength + pureTextLength > pageSize && currentPage.length > 0) {
                    pages.push(currentPage);
                    currentPage = part;
                } else {
                    currentPage += part;
                }
            }
            if (currentPage.trim().length > 0) pages.push(currentPage);
        } else {
            let lines = text.split('\n');
            let currentPage = "";
            for (let line of lines) {
                if (currentPage.length + line.length > pageSize && currentPage.length > 0) {
                    pages.push(currentPage);
                    currentPage = line + '\n';
                } else {
                    currentPage += line + '\n';
                }
            }
            if (currentPage.trim().length > 0) pages.push(currentPage);
        }
        return pages.length > 0 ? pages : ["æ— å†…å®¹"];
    }

    // æ¸²æŸ“æŒ‡å®šçš„å‰§æœ¬é¡µç 
    function renderPage(pageIndex) {
        currentViewingPageIndex = pageIndex;
        document.getElementById('act-content').innerHTML = currentTextPages[pageIndex];

        // åˆ¤æ–­ï¼šæ˜¯å¦åœ¨çœ‹æ¸¸æˆæœ€æ–°è¿›åº¦çš„å¹• && æ˜¯å¦æ˜¯æœ€åä¸€é¡µ
        const isLatestAct = (currentViewingActId === currentGameActId);
        const isLastPage = (currentViewingPageIndex === currentTextPages.length - 1);
        const alreadyDiscussed = discussedActIds.includes(currentViewingActId);

        const pageControls = document.getElementById('pagination-controls');
        if (currentTextPages.length > 1) {
            pageControls.style.display = 'flex';
            pageControls.innerHTML = `
                <button class="btn" onclick="prevPage()" ${pageIndex === 0 ? 'disabled' : ''}>â† ä¸Šä¸€é¡µ</button>
                <span>ç¬¬ ${pageIndex + 1} / ${currentTextPages.length} é¡µ</span>
                <button class="btn" onclick="nextPage()" ${pageIndex === currentTextPages.length - 1 ? 'disabled' : ''}>ä¸‹ä¸€é¡µ â†’</button>
            `;
        } else {
            pageControls.style.display = 'none';
            pageControls.innerHTML = '';
        }

        // æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
        const finishBtn = document.getElementById('btn-finish-read');
        const viewDiscussBtn = document.getElementById('btn-view-discuss');

        if (isLatestAct && isLastPage) {
            if (!alreadyDiscussed) {
                // å¦‚æœæ˜¯æœ€æ–°å¹•ä¸”æ²¡è®¨è®ºè¿‡ï¼Œæ˜¾ç¤ºè®¨è®ºè§¦å‘æŒ‰é’®
                finishBtn.style.display = 'block';
                viewDiscussBtn.style.display = 'none';
            } else {
                // å¦‚æœå·²ç»è®¨è®ºè¿‡äº†ï¼Œç»™ä¸ªå¿«æ·é”®å›åˆ°èŠå¤©å®¤
                finishBtn.style.display = 'none';
                viewDiscussBtn.style.display = 'block';
            }
        } else {
            // åœ¨çœ‹ä»¥å‰çš„å¹•æ¬¡æ—¶ï¼Œéšè—è¿™äº›æŒ‰é’®
            finishBtn.style.display = 'none';
            viewDiscussBtn.style.display = 'none';
        }
    }

    function prevPage() {
        if (currentViewingPageIndex > 0) {
            renderPage(currentViewingPageIndex - 1);
            window.scrollTo(0, 0);
        }
    }

    function nextPage() {
        if (currentViewingPageIndex < currentTextPages.length - 1) {
            renderPage(currentViewingPageIndex + 1);
            window.scrollTo(0, 0);
        }
    }

    // 5. è¯»å®Œå‰§æœ¬ï¼Œè·å– AI å‘è¨€
    async function finishReading() {
        switchView('view-discuss');
        document.getElementById('chat-container').innerHTML = '';
        document.getElementById('btn-next-act').style.display = 'none';
        document.getElementById('ai-loading').style.display = 'block';

        try {
            const res = await fetch(`${API_BASE}/finishReading?gameId=${currentGameId}`, { method: 'POST' }).then(r => r.json());
            document.getElementById('ai-loading').style.display = 'none';

            if (res.success) {
                // æ ‡è®°å½“å‰æœ€æ–°å¹•ä¸ºå·²è®¨è®º
                discussedActIds.push(currentGameActId);

                const chatBox = document.getElementById('chat-container');
                res.data.forEach(ai => {
                    chatBox.innerHTML += `
                        <div class="chat-box">
                            <div class="chat-avatar">${ai.roleName.substring(0,1)}</div>
                            <div class="chat-text">
                                <div class="chat-name">${ai.roleName} (AI)</div>
                                <div style="line-height: 1.6;">${ai.reply.replace(/\n/g, '<br>')}</div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('btn-next-act').style.display = 'block';
            } else {
                alert('è·å–AIå‘è¨€å¤±è´¥: ' + res.msg);
                document.getElementById('btn-next-act').style.display = 'block';
            }
        } catch (e) {
            console.error("AIç”Ÿæˆå‘è¨€å¼‚å¸¸:", e);
            document.getElementById('ai-loading').style.display = 'none';
            alert('è¯·æ±‚AIè¶…æ—¶æˆ–æŠ¥é”™ï¼Œè¯·é‡è¯•');
        }
    }

    // 6. è¿›å…¥ä¸‹ä¸€å¹•
    async function nextAct() {
        try {
            const res = await fetch(`${API_BASE}/nextAct?gameId=${currentGameId}`, { method: 'POST' }).then(r => r.json());
            if (res.success) {
                if (res.data.status === 'end') {
                    switchView('view-end');
                } else {
                    // æ›´æ–°æ¸¸æˆè¿›åº¦åˆ°ä¸‹ä¸€å¹•ï¼Œå¹¶è§£é”
                    currentGameActId = res.data.currentActId;
                    if (!unlockedActIds.includes(currentGameActId)) {
                        unlockedActIds.push(currentGameActId);
                    }
                    // åŠ è½½å¹¶æ¸²æŸ“ä¸‹ä¸€å¹•çš„æ•°æ®
                    loadActData(currentGameActId);
                }
            } else {
                alert(res.msg);
            }
        } catch (e) { console.error("è¿›å…¥ä¸‹ä¸€å¹•å¤±è´¥:", e); alert('è¿›å…¥ä¸‹ä¸€å¹•ç½‘ç»œè¯·æ±‚å¤±è´¥'); }
    }

    // åˆå§‹åŒ–åŠ è½½å¤§å…
    window.onload = loadScripts;
</script>
</body>
</html>