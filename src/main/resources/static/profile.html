<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰§é‡ - ä¸ªäººä¸­å¿ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            width: 100vw;
            height: 100vh;
            background: url("images/bg.jpg") no-repeat center center;
            background-size: cover;
            display: flex;
            padding: 20px;
            overflow: hidden;
        }
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            height: 100%;
            background: linear-gradient(180deg, #0f1a3a, #1a2a5a);
            border-radius: 20px;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .sidebar::before,
        .sidebar::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.2);
        }
        .sidebar::before {
            top: 15px;
            left: 15px;
            border-right: none;
            border-bottom: none;
            border-radius: 5px 0 0 0;
        }
        .sidebar::after {
            bottom: 15px;
            left: 15px;
            border-right: none;
            border-top: none;
            border-radius: 0 0 0 5px;
        }
        .sidebar-logo {
            text-align: center;
            margin-bottom: 50px;
        }
        .sidebar-logo h2 {
            color: #fff;
            font-size: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .sidebar-logo .star {
            width: 35px;
            height: 35px;
            background: #ff6600;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        .sidebar-logo .divider {
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #fff, transparent);
            margin: 15px auto 0;
        }
        .menu-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .menu-item {
            width: 100%;
            height: 60px;
            background: transparent;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 18px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.7;
        }
        .menu-item.active {
            background: linear-gradient(90deg, #ff6600, #ff3300);
            opacity: 1;
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.3);
        }
        .menu-item:hover {
            opacity: 1;
            background: rgba(255,255,255,0.1);
        }
        .logout-btn {
            width: 100%;
            height: 50px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .logout-btn:hover {
            border-color: #ff3300;
            color: #ff3300;
        }
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            height: 100%;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            margin-left: 20px;
            padding: 40px;
            overflow-y: auto;
        }
        .page-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 40px;
        }
        .page-title {
            font-size: 36px;
            font-weight: bold;
            color: #222;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
        .user-card {
            width: 100%;
            background: linear-gradient(90deg, #1a2a5a, #0f1a3a);
            border-radius: 20px;
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 40px;
            color: #fff;
        }
        .user-info-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9900, #ff3300);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            color: #fff;
        }
        .user-base h3 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .user-base .meta {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .user-base .meta span {
            opacity: 0.8;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .user-base .meta .gender-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .edit-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            color: #fff;
            padding: 10px 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .edit-btn:hover {
            background: #ff6600;
            border-color: #ff6600;
        }
        .user-info-right {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
        }
        .info-item {
            text-align: center;
        }
        .info-item .label {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 8px;
        }
        .info-item .value {
            font-size: 20px;
            font-weight: bold;
        }
        .info-item .hobby-tag {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        .level-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .level-progress {
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .level-progress .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff9900, #ff3300);
            width: 60%;
            border-radius: 4px;
        }
        .level-text {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 5px;
            font-size: 12px;
            opacity: 0.7;
        }
        /* åŠŸèƒ½å¡ç‰‡åŒº */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }
        .func-card {
            background: #fff;
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .func-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0;
            transition: all 0.3s;
        }
        .func-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .func-card:hover::before {
            opacity: 1;
        }
        .func-card .icon-wrapper {
            width: 70px;
            height: 80px;
            margin: 0 auto 20px;
            position: relative;
        }
        .func-card .icon-bg {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 30px;
            border-radius: 0 0 30px 30px;
            opacity: 0.3;
        }
        .func-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        .func-card h4 {
            font-size: 20px;
            color: #222;
            margin-bottom: 10px;
        }
        .func-card .record-count {
            font-size: 14px;
            color: #999;
            background: #f5f5f5;
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
        }
        /* å¡ç‰‡é¢œè‰²ä¸»é¢˜ */
        .card-1 { color: #3388ff; }
        .card-1 .icon { background: #e8f4ff; }
        .card-1 .icon-bg { background: #3388ff; }

        .card-2 { color: #33cc99; }
        .card-2 .icon { background: #e8fff4; }
        .card-2 .icon-bg { background: #33cc99; }

        .card-3 { color: #ff6666; }
        .card-3 .icon { background: #ffe8e8; }
        .card-3 .icon-bg { background: #ff6666; }

        .card-4 { color: #3366cc; }
        .card-4 .icon { background: #e8f0ff; }
        .card-4 .icon-bg { background: #3366cc; }

        .card-5 { color: #ffaa33; }
        .card-5 .icon { background: #fff8e8; }
        .card-5 .icon-bg { background: #ffaa33; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-logo">
        <h2>
            <span class="star"></span>
            å‰§é‡
        </h2>
        <div class="divider"></div>
    </div>
    <div class="menu-list">
        <button class="menu-item" onclick="goToPage('index.html')">
            <span>ğŸ </span>
            <span>é¦–é¡µ</span>
        </button>
        <button class="menu-item active" onclick="goToPage('profile.html')">
            <span>ğŸ‘¤</span>
            <span>ä¸ªäººä¿¡æ¯</span>
        </button>
        <button class="menu-item" onclick="goToPage('chat.html')">
            <span>ğŸ’¬</span>
            <span>å¥½å‹ç§ä¿¡</span>
        </button>
    </div>
    <button class="logout-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
</div>

<div class="main-content">
    <div class="page-header">
        <h1 class="page-title">ä¸ªäººä¸­å¿ƒ <span style="font-size:18px;color:#999;font-weight:normal;">ç®¡ç†ä½ çš„ä¸ªäººä¿¡æ¯ä¸ä¸“å±å†…å®¹</span></h1>
    </div>

    <div class="user-card">
        <div class="user-info-left">
            <div class="user-avatar" id="userAvatar">å‰§</div>
            <div class="user-base">
                <h3 id="userName">ä¸ªäººåå</h3>
                <div class="meta">
                    <span class="gender-dot" id="genderDot">âšª</span>
                    <span id="userGender">æ€§åˆ«</span>
                    <span>Â·</span>
                    <span id="userHobby">çˆ±å¥½ç±»å‹</span>
                </div>
            </div>
            <button class="edit-btn" id="editProfileBtn">ç¼–è¾‘èµ„æ–™</button>
        </div>
        <div class="user-info-right">
            <div class="info-item">
                <div class="label">å§“å</div>
                <div class="value" id="userRealName">å§“èƒœå</div>
            </div>
            <div class="info-item">
                <div class="label">çˆ±å¥½ç±»å‹</div>
                <div class="hobby-tag" id="userHobbyTag">æœªè®¾ç½®</div>
            </div>
            <div class="info-item level-container">
                <div class="label">ç­‰çº§</div>
                <div class="value">è¶…çº§ç­‰çº§ <span style="font-size:14px;">âš¡</span></div>
                <div class="level-progress">
                    <div class="progress-bar"></div>
                </div>
                <div class="level-text">
                    <span id="levelText">è¿›è¿›</span>
                    <span>9 å¤‡</span>
                </div>
            </div>
            <div class="info-item">
                <div class="label">ç”¨æˆ·ç­‰çº§</div>
                <div class="value">UID</div>
                <div style="font-size:14px;opacity:0.7;margin-top:5px;" id="userUid">------</div>
            </div>
        </div>
    </div>

    <div class="card-grid">
        <div class="func-card card-1" onclick="goToPage('play-record.html')">
            <div class="icon-wrapper">
                <div class="icon-bg"></div>
                <div class="icon">ğŸ“¦</div>
            </div>
            <h4>æˆ‘çš„ç©æœ¬è®°å½•</h4>
            <span class="record-count" id="playRecordCount">0 æ¡</span>
        </div>
        <div class="func-card card-2" onclick="goToPage('follow-history.html')">
            <div class="icon-wrapper">
                <div class="icon-bg"></div>
                <div class="icon">ğŸ“</div>
            </div>
            <h4>å†å²å…³æ³¨</h4>
            <span class="record-count" id="followCount">0 æ¡</span>
        </div>
        <div class="func-card card-3" onclick="goToPage('history-record.html')">
            <div class="icon-wrapper">
                <div class="icon-bg"></div>
                <div class="icon">ğŸ”–</div>
            </div>
            <h4>æµè§ˆè®°å½•</h4>
            <span class="record-count" id="historyCount">0 æ¡</span>
        </div>
        <div class="func-card card-4" onclick="goToPage('comment-record.html')">
            <div class="icon-wrapper">
                <div class="icon-bg"></div>
                <div class="icon">ğŸ›¡ï¸</div>
            </div>
            <h4>è¯„ä»·è®°å½•</h4>
            <span class="record-count" id="commentCount">0 æ¡</span>
        </div>
        <div class="func-card card-5" onclick="goToPage('my-creation.html')">
            <div class="icon-wrapper">
                <div class="icon-bg"></div>
                <div class="icon">ğŸ“š</div>
            </div>
            <h4>æˆ‘çš„åˆ›ä½œ</h4>
            <span class="record-count" id="creationCount">0 æ¡</span>
        </div>
    </div>
</div>

<script>
    // å…¨å±€é¡µé¢è·³è½¬æ–¹æ³•
    function goToPage(pageUrl) {
        const username = localStorage.getItem('loginUsername') || 'zhangsan';
        window.location.href = `${pageUrl}?username=${username}`;
    }

    // é¡µé¢åŠ è½½è·å–æ•°æ®
    window.onload = function() {
        loadUserProfile();
        loadUserStatistics();
    };

    // ã€ä¿®æ­£æ ¸å¿ƒã€‘åŠ è½½ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼Œé€‚é…åç«¯æ¥å£
    function loadUserProfile() {
        // ä¼˜å…ˆä»URLè·å–ç”¨æˆ·åï¼Œå…¶æ¬¡ä»æœ¬åœ°å­˜å‚¨
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || localStorage.getItem('loginUsername');

        // æ— ç”¨æˆ·åè·³è½¬åˆ°ç™»å½•é¡µ
        if (!username) {
            alert('è¯·å…ˆç™»å½•');
            window.location.href = 'login.html';
            return;
        }

        // ä¿®æ­£è¯·æ±‚è·¯å¾„ï¼Œå’Œåç«¯åŒ¹é…
        fetch(`/api/user/profile?username=${encodeURIComponent(username)}`)
            .then(res => {
                if (!res.ok) throw new Error(`æ¥å£çŠ¶æ€ç ï¼š${res.status}`);
                return res.json();
            })
            .then(result => {
                console.log('è·å–ç”¨æˆ·ä¿¡æ¯å“åº”:', result);
                // é€‚é…ç»Ÿä¸€çš„Resultè¿”å›æ ¼å¼
                if (result.code === 200) {
                    const user = result.data;
                    // å¡«å……ç”¨æˆ·ä¿¡æ¯
                    document.getElementById('userName').innerText = user.nickname || user.username || 'ä¸ªäººåå';
                    document.getElementById('userRealName').innerText = user.realName || user.username || 'å§“èƒœå';
                    document.getElementById('userUid').innerText = user.uid || '------';

                    // æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
                    const userAvatar = document.getElementById('userAvatar');
                    if (user.avatarUrl) {
                        userAvatar.innerHTML = `<img src="${user.avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        userAvatar.innerText = (user.nickname || user.username || 'å‰§').charAt(0);
                    }

                    // æ€§åˆ«å¤„ç†ï¼ˆé€‚é…tinyintç±»å‹ï¼š0=å¥³ï¼Œ1=ç”·ï¼‰
                    const genderMap = { 0: 'å¥³', 1: 'ç”·', undefined: 'æœªçŸ¥' };
                    const genderDotMap = { 0: 'â™€', 1: 'â™‚', undefined: 'âšª' };
                    document.getElementById('userGender').innerText = genderMap[user.gender] || 'æ€§åˆ«';
                    document.getElementById('genderDot').innerText = genderDotMap[user.gender] || 'âšª';

                    // çˆ±å¥½ç±»å‹
                    const hobby = user.hobbyType || 'æœªè®¾ç½®';
                    document.getElementById('userHobby').innerText = hobby;
                    document.getElementById('userHobbyTag').innerText = hobby;

                    // ç­‰çº§å¤„ç†
                    const userLevel = user.userLevel || 1;
                    document.getElementById('levelText').innerText = `Lv.${userLevel}`;
                    const progressPercent = userLevel * 20 > 100 ? 100 : userLevel * 20;
                    document.querySelector('.progress-bar').style.width = `${progressPercent}%`;

                    // å­˜å‚¨ç™»å½•ä¿¡æ¯
                    localStorage.setItem('userId', user.userId);
                    localStorage.setItem('loginUsername', username);
                } else {
                    throw new Error(result.msg || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
            })
            .catch(err => {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
                // å¼¹å‡ºå…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿æ’æŸ¥
                alert(`è·å–ä¸ªäººä¿¡æ¯å¤±è´¥ï¼š${err.message}ï¼Œè¯·åˆ·æ–°é‡è¯•`);
            });
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    function loadUserStatistics() {
        const username = new URLSearchParams(window.location.search).get('username') || localStorage.getItem('loginUsername');
        if (!username) return;

        fetch(`/api/user/statistics?username=${encodeURIComponent(username)}`)
            .then(res => res.json())
            .then(result => {
                console.log('è·å–ç»Ÿè®¡æ•°æ®å“åº”:', result);
                if (result.code === 200) {
                    const stat = result.data;
                    document.getElementById('playRecordCount').innerText = `${stat.playRecordCount || 0} æ¡`;
                    document.getElementById('followCount').innerText = `${stat.followCount || 0} æ¡`;
                    document.getElementById('historyCount').innerText = `${stat.historyCount || 0} æ¡`;
                    document.getElementById('commentCount').innerText = `${stat.commentCount || 0} æ¡`;
                    document.getElementById('creationCount').innerText = `${stat.creationCount || 0} æ¡`;
                }
            })
            .catch(err => console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', err));
    }

    // ç¼–è¾‘èµ„æ–™è·³è½¬
    document.getElementById('editProfileBtn').addEventListener('click', function() {
        goToPage('edit-profile.html');
    });

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            fetch('/api/user/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('é€€å‡ºæˆåŠŸ');
                        localStorage.removeItem('loginUsername');
                        localStorage.removeItem('userId');
                        window.location.href = 'login.html';
                    } else {
                        alert(data.msg);
                    }
                })
                .catch(err => {
                    console.error('é€€å‡ºç™»å½•å¤±è´¥:', err);
                    alert('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
        }
    });
</script>
</body>
</html>